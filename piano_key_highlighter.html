<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Piano Key Highlighter ‚Äî 4 Octaves (C3‚ÄìB6)</title>
<style>
  :root {
    --white:#ffffff;
    --black:#111111;
    --grey:#e9e9e9;
    --accent:#2b7cff;
    --accent2:#ff7a2b;
    --text:#222;
  }
  *{box-sizing:border-box}
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    margin:0;
    background:#fafafa;
    color:var(--text);
  }
  header{
    padding:14px 16px;
    border-bottom:1px solid #ddd;
    background:white;
    position:sticky; top:0; z-index:10;
  }
  h1{font-size:18px; margin:0 0 2px 0; font-weight:700}
  .subtitle{font-size:12px; color:#666}
  main{padding:14px 16px 24px}
  .panel{
    display:grid;
    grid-template-columns: repeat(6, minmax(120px, 1fr));
    gap:10px;
    align-items:end;
    margin-bottom:12px;
  }
  label{font-size:12px; color:#444; display:block; margin-bottom:6px;}
  select, input[type="text"]{
    font:inherit;
    padding:8px 10px;
    border:1px solid #ccc;
    border-radius:8px;
    width:100%;
    background:white;
  }
  .row{display:flex; gap:10px; flex-wrap:wrap}
  button{
    padding:9px 12px;
    border:1px solid #bbb;
    border-radius:8px;
    background:white;
    cursor:pointer;
  }
  button.primary{
    border-color:transparent;
    background:var(--accent);
    color:white;
  }
  .kbd{
    display:inline-block;
    border:1px solid #ccc;
    border-bottom-width:2px;
    padding:1px 6px;
    border-radius:6px;
    background:#fff;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    font-size:12px;
  }
  .legend{display:flex; align-items:center; gap:12px; margin-top:10px; flex-wrap:wrap;}
  .chip{display:inline-flex; align-items:center; gap:6px; font-size:12px}
  .dot{width:14px; height:14px; border-radius:50%}
  .root{background:var(--accent2); border:1px solid rgba(0,0,0,.2)}
  .member{background:var(--accent); border:1px solid rgba(0,0,0,.2)}
  .ghost{background:#aaa; border:1px solid rgba(0,0,0,.2)}
  .wrap{
    overflow-x:auto;
    border:1px solid #ddd;
    border-radius:12px;
    background:linear-gradient(#fff, #f8f8f8);
    padding:12px;
  }
  svg{display:block; height:auto; max-width:none}
  .white-key { fill: var(--white); stroke: #999; stroke-width:1; }
  .black-key { fill: var(--black); stroke: #000; stroke-width:1; }
  .label { font-size:10px; fill:#333; user-select:none; }
  .on .white-key { fill: #dfeaff; }
  .on .black-key { fill: #3057b8; }
  .root-on .white-key { fill: #ffe2cf; }
  .root-on .black-key { fill: #c5561e; }
  .note-name { font-size:9px; fill:#222; text-anchor:middle; pointer-events:none; }
  .note-name.dark { fill:#fff; }
  footer{padding:10px 16px; color:#666; font-size:12px}
  details{margin-top:10px}
  .flex-grow{flex:1}
</style>
</head>
<body>
<header>
  <h1>üéπ Piano Key Highlighter</h1>
  <div class="subtitle">Interactive 4-octave keyboard (C3‚ÄìB6). Highlight chords & scales for practice.</div>
</header>
<main>
  <section class="panel">
    <div>
      <label for="mode">What to show</label>
      <select id="mode">
        <option value="scale" selected>Scale</option>
        <option value="chord">Chord</option>
        <option value="custom">Custom (type notes)</option>
      </select>
    </div>
    <div>
      <label for="root">Root</label>
      <select id="root">
        <option>C</option><option>C#</option><option>Db</option>
        <option>D</option><option>D#</option><option>Eb</option>
        <option>E</option><option>F</option><option>F#</option><option>Gb</option>
        <option>G</option><option>G#</option><option>Ab</option>
        <option>A</option><option>A#</option><option>Bb</option>
        <option>B</option>
      </select>
    </div>
    <div>
      <label for="type">Type</label>
      <select id="type">
        <!-- Scales -->
        <optgroup label="Scales">
          <option value="major">Major (Ionian)</option>
          <option value="nat_minor">Natural Minor (Aeolian)</option>
          <option value="dorian">Dorian</option>
          <option value="phrygian">Phrygian</option>
          <option value="lydian">Lydian</option>
          <option value="mixolydian">Mixolydian</option>
          <option value="locrian">Locrian</option>
          <option value="maj_pent">Major Pentatonic</option>
          <option value="min_pent">Minor Pentatonic</option>
          <option value="blues">Blues (Hexatonic)</option>
          <option value="harm_minor">Harmonic Minor</option>
          <option value="mel_minor">Melodic Minor (Jazz)</option>
        </optgroup>
        <!-- Chords -->
        <optgroup label="Chords">
          <option value="maj_triad">Major (Triad)</option>
          <option value="min_triad">Minor (Triad)</option>
          <option value="dim_triad">Diminished (Triad)</option>
          <option value="aug_triad">Augmented (Triad)</option>
          <option value="maj7">Maj7</option>
          <option value="min7">m7</option>
          <option value="dom7">7 (Dominant)</option>
          <option value="minMaj7">m(maj7)</option>
          <option value="halfDim7">m7(b5)</option>
          <option value="dim7">dim7</option>
          <option value="sus2">sus2</option>
          <option value="sus4">sus4</option>
          <option value="add9">add9 (triad+9)</option>
          <option value="6">6</option>
          <option value="m6">m6</option>
          <option value="9">9 (1 3 5 b7 9)</option>
          <option value="m9">m9 (1 b3 5 b7 9)</option>
        </optgroup>
      </select>
    </div>
    <div>
      <label for="showNames">Note labels</label>
      <select id="showNames">
        <option value="none">None</option>
        <option value="letter" selected>Letter (C, C#)</option>
        <option value="letter_oct">Letter+Octave (C4)</option>
      </select>
    </div>
    <div>
      <label for="range">Keyboard range</label>
      <select id="range">
        <option value="C3-B6" selected>C3‚ÄìB6 (4 octaves)</option>
        <option value="C2-B5">C2‚ÄìB5</option>
        <option value="C4-B7">C4‚ÄìB7</option>
      </select>
    </div>
    <div>
      <label for="custom">Custom notes <span style="color:#888">(e.g. C4,E4,G4,Bb4)</span></label>
      <input id="custom" type="text" placeholder="When mode = Custom, type comma-separated notes">
    </div>
  </section>
  <div class="row" style="margin-bottom:10px">
    <button class="primary" id="apply">Apply</button>
    <button id="clear">Clear</button>
    <span class="flex-grow"></span>
    <div class="legend">
      <span class="chip"><span class="dot root"></span>Root</span>
      <span class="chip"><span class="dot member"></span>Member</span>
      <span class="chip"><span class="dot ghost"></span>Non-member (ghosted)</span>
    </div>
  </div>

  <div class="wrap">
    <svg id="piano" xmlns="http://www.w3.org/2000/svg" width="1600" height="220" viewBox="0 0 1600 220" aria-labelledby="title desc" role="img">
      <title id="title">Interactive piano keyboard</title>
      <desc id="desc">Click keys to audition. Use controls to highlight chords/scales.</desc>
    </svg>
  </div>

  <details>
    <summary>Tips</summary>
    <ul>
      <li>Use <span class="kbd">Shift</span> + click to toggle individual keys.</li>
      <li>Change the <b>Root</b> spelling between sharps and flats to match your chart.</li>
      <li>Ranges are 4 octaves wide; choose the one that fits your exercise.</li>
      <li>Mode ‚ÄúCustom‚Äù accepts <code>C#4, Db4, Bb3, F5</code> etc. Octaves optional.</li>
    </ul>
  </details>
</main>
<footer>
  Built for study: clean visuals, no dependencies, fully offline. ¬© 2025
</footer>

<script>
(function(){
  // ---------- Music theory utilities ----------
  const NAMES_SHARP = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
  const NAMES_FLAT  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];

  function nameFor(pc, preferFlat=false){
    return preferFlat ? NAMES_FLAT[pc] : NAMES_SHARP[pc];
  }

  function parseNoteName(s){
    // Accept C, C#, Db, Bb4, etc. Return {pc, octave|null}
    const m = String(s).trim().match(/^([A-Ga-g])([#b]?)(\d+)?$/);
    if(!m) return null;
    const letter = m[1].toUpperCase();
    const acc = m[2] || "";
    const octave = m[3] !== undefined ? parseInt(m[3],10) : null;
    const map = {C:0,D:2,E:4,F:5,G:7,A:9,B:11};
    let pc = map[letter];
    if(acc === "#") pc = (pc+1)%12;
    if(acc === "b") pc = (pc+11)%12;
    return {pc, octave};
  }

  function pcFromName(name){
    const p = parseNoteName(name);
    if(!p) return null;
    return p.pc;
  }

  function uniq(arr){ return Array.from(new Set(arr)); }

  // Intervals in semitones for scales/chords (0 = root)
  const SCALES = {
    major:        [0,2,4,5,7,9,11],
    nat_minor:    [0,2,3,5,7,8,10],
    dorian:       [0,2,3,5,7,9,10],
    phrygian:     [0,1,3,5,7,8,10],
    lydian:       [0,2,4,6,7,9,11],
    mixolydian:   [0,2,4,5,7,9,10],
    locrian:      [0,1,3,5,6,8,10],
    maj_pent:     [0,2,4,7,9],
    min_pent:     [0,3,5,7,10],
    blues:        [0,3,5,6,7,10],
    harm_minor:   [0,2,3,5,7,8,11],
    mel_minor:    [0,2,3,5,7,9,11],
  };

  const CHORDS = {
    maj_triad:  [0,4,7],
    min_triad:  [0,3,7],
    dim_triad:  [0,3,6],
    aug_triad:  [0,4,8],
    maj7:       [0,4,7,11],
    min7:       [0,3,7,10],
    dom7:       [0,4,7,10],
    minMaj7:    [0,3,7,11],
    halfDim7:   [0,3,6,10],
    dim7:       [0,3,6,9],
    sus2:       [0,2,7],
    sus4:       [0,5,7],
    add9:       [0,4,7,14],
    "6":        [0,4,7,9],
    m6:         [0,3,7,9],
    "9":        [0,4,7,10,14],
    m9:         [0,3,7,10,14],
  };

  // ---------- Keyboard rendering ----------
  const piano = document.getElementById('piano');
  let state = {
    range: "C3-B6",
    preferFlat: false,
    showNames: "letter",
    highlightedPCs: new Set(),
    rootPC: 0,
    activeNotes: new Set(), // midi numbers currently lit
    shiftToggle: false
  };

  function midiNumber(pc, octave){ // C4 = 60 (MIDI standard)
    return (octave + 1) * 12 + pc;
  }

  function parseRange(r){ // "C3-B6"
    const [lo, hi] = r.split('-').map(parseNoteName);
    if(!lo || !hi || lo.octave === null || hi.octave === null) return {min:48, max:95}; // default
    const min = midiNumber(lo.pc, lo.octave);
    const max = midiNumber(hi.pc, hi.octave);
    return {min, max};
  }

  function isBlack(pc){
    return [1,3,6,8,10].includes(pc);
  }

  function buildKeyboard(rangeStr){
    piano.innerHTML = "";
    const {min, max} = parseRange(rangeStr);
    // Layout metrics
    const whiteWidth = 26;
    const whiteHeight = 180;
    const blackWidth = Math.round(whiteWidth * 0.62);
    const blackHeight = Math.round(whiteHeight * 0.62);
    const gap = 1;

    // Build white keys first
    let x = 0;
    const whiteKeyPositions = []; // map midi -> x
    const keyGroups = {}; // midi -> <g>

    for(let m=min; m<=max; m++){
      const pc = m % 12;
      if(!isBlack(pc)){
        const g = document.createElementNS("http://www.w3.org/2000/svg","g");
        g.setAttribute("data-midi", m);
        g.setAttribute("data-pc", pc);
        g.setAttribute("class","key white");
        g.style.cursor = "pointer";
        const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
        rect.setAttribute("class","white-key");
        rect.setAttribute("x", x);
        rect.setAttribute("y", 0);
        rect.setAttribute("width", whiteWidth-gap);
        rect.setAttribute("height", whiteHeight);
        g.appendChild(rect);

        // label
        if(state.showNames !== "none"){
          const oct = Math.floor(m/12)-1;
          const nm = state.showNames==="letter_oct" ? (nameFor(pc, state.preferFlat)+oct) : nameFor(pc, state.preferFlat);
          const text = document.createElementNS("http://www.w3.org/2000/svg","text");
          text.setAttribute("class","note-name");
          text.setAttribute("x", x + (whiteWidth-gap)/2);
          text.setAttribute("y", whiteHeight - 8);
          text.textContent = nm;
          g.appendChild(text);
        }

        piano.appendChild(g);
        whiteKeyPositions[m] = x;
        keyGroups[m] = g;
        x += whiteWidth;
      }
    }

    // Then black keys on top, positioned between whites
    for(let m=min; m<=max; m++){
      const pc = m % 12;
      if(isBlack(pc)){
        // Find preceding white key x and position centered between
        const prevWhiteMidi = m - 1;
        const nextWhiteMidi = m + 1;
        const prevX = whiteKeyPositions[prevWhiteMidi];
        const nextX = whiteKeyPositions[nextWhiteMidi];
        if(prevX === undefined || nextX === undefined) continue;
        const bx = prevX + (nextX - prevX) * 0.64 - blackWidth/2; // slight skew to look natural
        const g = document.createElementNS("http://www.w3.org/2000/svg","g");
        g.setAttribute("data-midi", m);
        g.setAttribute("data-pc", pc);
        g.setAttribute("class","key black");
        g.style.cursor = "pointer";

        const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
        rect.setAttribute("class","black-key");
        rect.setAttribute("x", bx);
        rect.setAttribute("y", 0);
        rect.setAttribute("width", blackWidth);
        rect.setAttribute("height", blackHeight);
        rect.setAttribute("rx", 3);
        rect.setAttribute("ry", 3);
        g.appendChild(rect);

        if(state.showNames !== "none"){
          const oct = Math.floor(m/12)-1;
          const nm = state.showNames==="letter_oct" ? (nameFor(pc, state.preferFlat)+oct) : nameFor(pc, state.preferFlat);
          const text = document.createElementNS("http://www.w3.org/2000/svg","text");
          text.setAttribute("class","note-name dark");
          text.setAttribute("x", bx + blackWidth/2);
          text.setAttribute("y", blackHeight - 6);
          text.textContent = nm;
          g.appendChild(text);
        }

        piano.appendChild(g);
        keyGroups[m] = g;
      }
    }

    // Resize viewBox/width based on total white keys
    const whiteCount = Object.keys(whiteKeyPositions).length;
    const width = whiteCount * whiteWidth;
    piano.setAttribute("viewBox", `0 0 ${width} ${whiteHeight}`);
    piano.setAttribute("width", Math.min(1600, width));

    // Interactions
    piano.querySelectorAll(".key").forEach(k => {
      k.addEventListener("click", (ev)=>{
        const midi = +k.getAttribute("data-midi");
        if (ev.shiftKey || state.shiftToggle) {
          toggleKey(midi);
        } else {
          // solo toggle
          clearAll();
          toggleKey(midi, true);
        }
      });
    });

    // Save for coloring later
    state.keyGroups = keyGroups;
  }

  function clearAll(){
    state.activeNotes.clear();
    for(const m in state.keyGroups){
      const g = state.keyGroups[m];
      g.classList.remove("on","root-on");
      g.style.opacity = 1;
    }
  }

  function colorAccordingToSet(memberPCs, rootPC){
    // Ghost non-members lightly
    for(const mid in state.keyGroups){
      const g = state.keyGroups[mid];
      const pc = +g.getAttribute("data-pc");
      if(memberPCs.has(pc)){
        g.style.opacity = 1;
        g.classList.toggle("root-on", pc === rootPC);
        g.classList.toggle("on", pc !== rootPC);
      }else{
        g.classList.remove("on","root-on");
        g.style.opacity = 0.28;
      }
    }
  }

  function toggleKey(midi, forceOn=false){
    const g = state.keyGroups[midi];
    if(!g) return;
    const isOn = g.classList.contains("on") || g.classList.contains("root-on");
    const willOn = forceOn ? true : !isOn;
    if(willOn){
      g.classList.add("on");
      g.style.opacity = 1;
      state.activeNotes.add(midi);
      beep(midi, 0.12);
    }else{
      g.classList.remove("on","root-on");
      state.activeNotes.delete(midi);
    }
  }

  // Very lightweight beep using WebAudio (sine + quick envelope)
  let audioCtx = null;
  function beep(midi, dur=0.12){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const freq = 440 * Math.pow(2, (midi-69)/12);
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = "sine";
      osc.frequency.value = freq;
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      const t = audioCtx.currentTime;
      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(0.18, t+0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, t+dur);
      osc.start(t);
      osc.stop(t+dur+0.01);
    }catch(e){ /* ignore */ }
  }

  // ---------- UI wiring ----------
  const $ = id => document.getElementById(id);
  const modeSel = $("mode");
  const rootSel = $("root");
  const typeSel = $("type");
  const namesSel = $("showNames");
  const rangeSel = $("range");
  const customInput = $("custom");

  function apply(){
    state.showNames = namesSel.value;
    state.range = rangeSel.value;
    state.preferFlat = /b/.test(rootSel.value) && !rootSel.value.includes("#");
    buildKeyboard(state.range);
    // Compute membership set
    const rootPC = pcFromName(rootSel.value);
    state.rootPC = rootPC ?? 0;

    let pcs = new Set();
    if(modeSel.value === "scale"){
      const ivs = SCALES[typeSel.value] || SCALES.major;
      pcs = new Set(ivs.map(i => (state.rootPC + i) % 12));
    }else if(modeSel.value === "chord"){
      const ivs = CHORDS[typeSel.value] || CHORDS.maj_triad;
      pcs = new Set(ivs.map(i => (state.rootPC + i) % 12));
    }else{
      // Custom
      const list = customInput.value.split(",").map(s=>s.trim()).filter(Boolean);
      const pcsArr = list.map(pcFromName).filter(v=>v!==null);
      pcs = new Set(pcsArr);
    }
    state.highlightedPCs = pcs;
    colorAccordingToSet(pcs, state.rootPC);
  }

  $("apply").addEventListener("click", apply);
  $("clear").addEventListener("click", ()=>{ buildKeyboard(state.range); });

  // URL hash sync (shareable)
  function saveHash(){
    const data = {
      m: modeSel.value,
      r: rootSel.value,
      t: typeSel.value,
      n: namesSel.value,
      g: rangeSel.value,
      c: customInput.value
    };
    location.hash = encodeURIComponent(JSON.stringify(data));
  }
  function loadHash(){
    try{
      const h = location.hash.replace(/^#/, "");
      if(!h) return;
      const data = JSON.parse(decodeURIComponent(h));
      if(data.m) modeSel.value = data.m;
      if(data.r) rootSel.value = data.r;
      if(data.t) typeSel.value = data.t;
      if(data.n) namesSel.value = data.n;
      if(data.g) rangeSel.value = data.g;
      if(data.c) customInput.value = data.c;
    }catch(e){ /* ignore */ }
  }
  ["mode","root","type","showNames","range","custom"].forEach(id=>{
    $(id).addEventListener("change", saveHash);
    $(id).addEventListener("input", saveHash);
  });

  // Init
  loadHash();
  apply();
})();
</script>
</body>
</html>
